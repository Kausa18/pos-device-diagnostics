<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>POS Diagnostics Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .card {
            border: 1px solid #ccc;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 6px;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            overflow-x: auto;
        }
        .pass {
            color: green;
            font-weight: bold;
        }
        .fail {
            color: red;
            font-weight: bold;
        }
        .skipped {
            color: orange;
            font-weight: bold;
        }
        ul {
            list-style-type: none;
            padding-left: 0;
        }
        li {
            margin-bottom: 4px;
        }
    </style>
</head>
<body>

<h1>POS Diagnostics Dashboard</h1>

<div id="list">Loadingâ€¦</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const terminal_id = urlParams.get('terminal_id');

fetch("/diagnostics" + (terminal_id ? `?terminal_id=${terminal_id}` : ""))
    .then(res => res.json())
    .then(data => {
        const list = document.getElementById("list");

        if (data.length === 0) {
            list.innerHTML = terminal_id ? `<p>No diagnostics found for terminal: ${terminal_id}</p>` : "<p>No diagnostics uploaded yet.</p>";
            return;
        }

        list.innerHTML = terminal_id ? `<h2>Diagnostics for Terminal: ${terminal_id}</h2>` : "<h2>All Diagnostics</h2>";

        data.reverse().forEach(item => {
            const div = document.createElement("div");
            div.className = "card";
            
            let resultsHtml = '';
            if (item.payload.results && Array.isArray(item.payload.results)) {
                resultsHtml = '<h4>Diagnostic Results:</h4><ul>';
                item.payload.results.forEach(result => {
                    const statusClass = result.status === 'PASS' ? 'pass' : result.status === 'FAIL' ? 'fail' : 'skipped';
                    resultsHtml += `<li class="${statusClass}"><strong>${result.name}:</strong> ${result.status}`;
                    if (result.details) {
                        resultsHtml += ` - ${result.details}`;
                    }
                    resultsHtml += '</li>';
                });
                resultsHtml += '</ul>';
            }
            
            div.innerHTML = `
                <strong>Terminal ID:</strong> ${item.payload.terminal_id}<br/>
                <strong>Status:</strong> <span class="${item.summaryStatus === 'pass' ? 'pass' : 'fail'}">${item.summaryStatus}</span><br/>
                <strong>Received:</strong> ${item.receivedAt}<br/>
                <strong>Device:</strong> ${item.payload.manufacturer} ${item.payload.model} (Android ${item.payload.androidVersion})<br/>
                ${resultsHtml}
                <details>
                    <summary>Raw Data</summary>
                    <pre>${JSON.stringify(item.payload, null, 2)}</pre>
                </details>
            `;
            list.appendChild(div);
        });
    })
    .catch(() => {
        document.getElementById("list").innerText = "Failed to load diagnostics";
    });
</script>

</body>
</html>