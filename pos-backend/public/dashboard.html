<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>POS Diagnostics Fleet - Overview</title>
    <style>
        :root {
            --primary: #1e88e5;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #f9a825;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --text-muted: #7f8c8d;
        }

        body { font-family: 'Segoe UI', Roboto, Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        
        .header { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(10px);
            padding: 12px 40px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container { max-width: 900px; margin: 40px auto; background: var(--card-bg); padding: 50px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); text-align: center; }
        
        h1 { font-size: 32px; font-weight: 800; margin-bottom: 8px; color: #1a2a3a; }
        .subtitle { color: var(--text-muted); font-size: 14px; margin-bottom: 40px; }

        .chart-container { position: relative; width: 280px; height: 280px; margin: 0 auto 30px; }
        .pie-chart { width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .inner-circle { width: 65%; height: 65%; background: var(--card-bg); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .inner-circle span { font-size: 12px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .inner-circle strong { font-size: 36px; color: var(--text); }

        .legend { display: flex; justify-content: center; gap: 30px; margin-bottom: 40px; }
        .legend-item { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; color: var(--text-muted); }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.pass { background: var(--success); }
        .dot.fail { background: var(--danger); }
        .dot.none { background: var(--warning); }

        .refresh-btn { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 13px; font-weight: 700; margin-bottom: 40px; display: inline-flex; align-items: center; gap: 6px; }

        .toolbar { border-top: 1px solid #f0f0f0; padding-top: 40px; }
        .search-row { margin-bottom: 25px; position: relative; }
        .search-row input { width: 100%; padding: 16px 16px 16px 45px; border: 2px solid #f0f0f0; border-radius: 12px; font-size: 15px; box-sizing: border-box; }
        .search-icon { position: absolute; left: 18px; top: 18px; }

        .button-group { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        .action-btn { padding: 14px 24px; border: none; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; text-decoration: none; transition: 0.3s; }
        .btn-blue { background: var(--primary); }
        .btn-green { background: var(--success); }
        .btn-red { background: var(--danger); }
        .btn-amber { background: var(--warning); }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        .btn-logout { background: #f8f9fa; border: 1px solid #ddd; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; }
        .btn-logout:hover { background: #fee; color: #c00; border-color: #fcc; }
        
        .admin-link { color: var(--primary); text-decoration: none; font-size: 13px; font-weight: 800; margin-right: 20px; }
        .brand { font-weight: 900; color: var(--primary); letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="header">
    <div class="brand">POS.LOCAL</div>
    <div>
        <span id="adminLinks"></span>
        <button class="btn-logout" onclick="logout()">LOGOUT</button>
    </div>
</div>

<div class="container">
    <h1>Fleet Status Overview</h1>
    <div class="subtitle">System diagnostics and operation readiness</div>

    <div class="chart-container">
        <div id="pieChart" class="pie-chart">
            <div class="inner-circle">
                <span>Total Units</span>
                <strong id="centerTotal">0</strong>
            </div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="dot pass"></div> Passed</div>
        <div class="legend-item"><div class="dot fail"></div> Failed</div>
        <div class="legend-item"><div class="dot none"></div> Not Tested</div>
    </div>

    <button class="refresh-btn" onclick="loadStats()">‚Üª REFRESH DATA</button>

    <div class="toolbar">
        <div class="search-row">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" placeholder="Search Terminal ID..." onkeyup="handleSearch(event)">
        </div>
        
        <div class="button-group">
            <a href="/devices.html" class="action-btn btn-blue">Full Fleet Registry</a>
            <a href="/devices.html?status=pass" class="action-btn btn-green">View Passed</a>
            <a href="/devices.html?status=fail" class="action-btn btn-red">View Failed</a>
            <a href="/devices.html?status=none" class="action-btn btn-amber">View Not Tested</a>
        </div>
    </div>
</div>

<script>
    // Ensure session exists
    const userStr = sessionStorage.getItem('user');
    if (!userStr) window.location.href = '/login.html';
    const user = JSON.parse(userStr);

    if (user.role === 'admin') {
        document.getElementById('adminLinks').innerHTML = `
            <a href="/users.html" class="admin-link">‚öô USER MANAGEMENT</a>
            <a href="/register.html" class="admin-link" style="color:var(--success);">+ REGISTER DEVICE</a>
        `;
    }

    async function loadStats() {
        try {
            const res = await fetch(`/terminals/stats?api_key=supersecret123`);
            const stats = await res.json();
            document.getElementById('centerTotal').innerText = stats.total || 0;
            updatePieChart(stats);
        } catch (err) { console.error(err); }
    }

    function updatePieChart(s) {
        const total = s.total || 1;
        const pP = ((s.passed || 0) / total) * 360;
        const pF = ((s.failed || 0) / total) * 360;
        const pN = ((s.not_tested || 0) / total) * 360;
        document.getElementById('pieChart').style.background = `conic-gradient(#28a745 0deg ${pP}deg, #dc3545 ${pP}deg ${pP + pF}deg, #f9a825 ${pP + pF}deg 360deg)`;
    }

    function handleSearch(e) {
        if (e.key === 'Enter' && e.target.value.trim() !== "") {
            window.location.href = `/devices.html?search=${encodeURIComponent(e.target.value.trim())}`;
        }
    }

    function logout() {
        sessionStorage.clear();
        window.location.href = '/login.html';
    }

    loadStats();
</script>

</body>
</html>
