<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Diagnostic Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --primary: #1e88e5; --success: #28a745; --danger: #dc3545; --warning: #f9a825;
            --bg: #f0f2f5; --card-bg: #ffffff; --text: #2c3e50; --text-muted: #7f8c8d;
            --sidebar-bg: #1a2a3a; --sidebar-text: #bdc3c7; --sidebar-active: #ffffff;
        }
        body { font-family: 'Segoe UI', Roboto, Arial, sans-serif; margin: 0; background: var(--bg); display: flex; }
        
        /* Sidebar */
        .sidebar { 
            width: 260px; 
            background: var(--sidebar-bg); 
            color: var(--sidebar-text); 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            position: fixed; 
            transition: width 0.3s ease;
            z-index: 200;
        }
        .sidebar-brand { padding: 20px; font-size: 20px; font-weight: 900; color: var(--sidebar-active); text-align: center; border-bottom: 1px solid #2c3e50; white-space: nowrap; overflow: hidden; }
        .sidebar-nav { flex-grow: 1; }
        .sidebar-nav-section { font-size: 12px; text-transform: uppercase; padding: 20px 20px 10px; font-weight: 700; color: #7f8c8d; overflow: hidden; white-space: nowrap; }
        .sidebar-nav a { display: flex; align-items: center; gap: 15px; color: var(--sidebar-text); text-decoration: none; padding: 12px 20px; font-weight: 600; transition: 0.2s; border-left: 3px solid transparent; white-space: nowrap; }
        .sidebar-nav a i { font-size: 22px; min-width: 22px; text-align: center; }
        .sidebar-nav a:hover { background: #2c3e50; color: var(--sidebar-active); }
        .sidebar-nav a.active { background: #2c3e50; color: var(--sidebar-active); border-left-color: var(--primary); }

        .sidebar-toggle {
            border-top: 1px solid #2c3e50;
            padding: 15px 0;
            text-align: center;
            cursor: pointer;
            color: var(--sidebar-text);
        }
        .sidebar-toggle i { font-size: 24px; transition: transform 0.3s ease; }

        /* Collapsed Sidebar */
        .sidebar.collapsed { width: 80px; }
        .sidebar.collapsed .sidebar-brand .link-text, .sidebar.collapsed .sidebar-nav-section, .sidebar.collapsed .link-text { display: none; }
        .sidebar.collapsed .sidebar-brand { font-size: 14px; }
        .sidebar.collapsed .sidebar-nav a { justify-content: center; padding: 12px 10px; }
        .sidebar.collapsed .sidebar-toggle i { transform: rotate(180deg); }
        
        /* Main Content */
        .main-content { 
            flex-grow: 1; 
            margin-left: 260px; 
            display: flex; 
            flex-direction: column; 
            transition: margin-left 0.3s ease;
        }
        .main-content.collapsed { margin-left: 80px; }
        .header { background: var(--card-bg); padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0; position: sticky; top: 0; z-index: 100; }
        .header-left { flex-grow: 1; }
        .header-right { display: flex; align-items: center; gap: 25px; }

        .user-profile, .notification-container { position: relative; }
        .user-profile > i, .notification-container > i { font-size: 28px; cursor: pointer; color: #555; }
        
        .profile-dropdown, .notification-dropdown { display: none; position: absolute; top: 140%; right: 0; background: var(--card-bg); border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-width: 220px; z-index: 101; padding: 10px; }
        .profile-dropdown.show, .notification-dropdown.show { display: block; }
        
        .profile-dropdown-header { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px; }
        .profile-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .profile-dropdown-header div { font-weight: 600; }
        .profile-dropdown-links a, .profile-dropdown-links button { display: block; background: none; border: none; text-align: left; width: 100%; padding: 10px; border-radius: 6px; font-size: 14px; color: var(--text); text-decoration: none; cursor: pointer; }
        .profile-dropdown-links a:hover, .profile-dropdown-links button:hover { background: #f0f2f5; }

        .notification-count { display: none; position: absolute; top: -5px; right: -8px; background: var(--danger); color: white; border-radius: 50%; padding: 2px 6px; font-size: 11px; font-weight: bold; }
        .notification-dropdown a { display: block; padding: 10px 15px; font-size: 14px; color: var(--text); text-decoration: none; border-bottom: 1px solid #f0f0f0; }
        .notification-dropdown a:last-child { border-bottom: none; }
        .notification-dropdown a:hover { background: #f8f9fa; }
        .no-notifications { padding: 15px; color: var(--text-muted); font-style: italic; }

        main { padding: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }

        .kpi-card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s ease-in-out; }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .kpi-card .title { font-size: 14px; font-weight: 600; color: var(--text-muted); margin-bottom: 10px; }
        .kpi-card .value { font-size: 32px; font-weight: 800; color: var(--text); }
        .kpi-card .value .unit { font-size: 16px; font-weight: 600; color: var(--text-muted); margin-left: 5px; }
        .kpi-card .value.critical { color: var(--danger); }
        .kpi-card .value.success { color: var(--success); }

        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .card-title-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 18px; font-weight: 700; margin-bottom: 0; }
        .chart-filter { display: flex; align-items: center; gap: 8px; }
        .chart-filter select { border: 1px solid #ddd; padding: 4px 8px; border-radius: 6px; font-size: 13px; }

        /* Chart Styles */
        .pie-chart-container { position: relative; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .pie-chart-svg { width: 180px; height: 180px; }
        .pie-slice { stroke: white; stroke-width: 1; cursor: pointer; transition: transform 0.2s ease-out; }
        .pie-slice:hover { transform: scale(1.05); }
        .chart-tooltip { position: absolute; background-color: rgba(0, 0, 0, 0.8); color: white; padding: 8px 12px; border-radius: 4px; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 10; white-space: nowrap; transform: translate(-50%, -120%); }
        .pie-chart-legend { display: flex; justify-content: center; gap: 20px; margin-top: 15px; }
        .legend-item { display: flex; align-items: center; font-size: 13px; }
        .legend-color { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }

        /* Activity Feed */
        .activity-feed { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; }
        .activity-feed li { padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .activity-feed li:last-child { border: none; }
        .activity-feed .time { font-size: 12px; color: var(--text-muted); display: block; margin-top: 4px; }
        .activity-feed .highlight { color: var(--danger); font-weight: bold; }

    </style>
</head>
<body>
<div class="sidebar">
    <div class="sidebar-brand"><span class="link-text">IZYANE DIAGNOSTICS</span></div>
    <div class="sidebar-nav">
        <div class="sidebar-nav-section">Overall Dashboard</div>
        <a href="dashboard.html" class="active"><i class='bx bxs-dashboard'></i><span class="link-text">Dashboard</span></a>

        <div class="sidebar-nav-section">Device Management</div>
        <a href="devices.html"><i class='bx bx-desktop'></i><span class="link-text">Devices</span></a>
        <a href="daily_report.html"><i class='bx bxs-report'></i><span class="link-text">Reports</span></a>
        <a href="test_logs.html"><i class='bx bx-history'></i><span class="link-text">Test Report Logs</span></a>
        
        <div class="sidebar-nav-section" id="admin-section">Admin</div>
        <a href="users.html" id="adminUsersLink"><i class='bx bxs-user-account'></i><span class="link-text">User Management</span></a>
        <a href="settings.html" id="adminSettingsLink"><i class='bx bxs-cog'></i><span class="link-text">Settings</span></a>

        <div class="sidebar-nav-section">Account</div>
        <a href="profile.html"><i class='bx bxs-user-circle'></i><span class="link-text">Profile</span></a>
    </div>
    <div class="sidebar-toggle" onclick="toggleSidebar()">
        <i class='bx bx-chevron-left'></i>
    </div>
</div>

<div class="main-content">
    <div class="header">
        <div id="welcomeMessage" style="font-weight: 600; flex-grow: 1;"></div>
        <div class="header-right">
            <div class="notification-container" id="notification-bell" style="display: none;">
                <i class='bx bxs-bell'></i>
                <span class="notification-count">0</span>
                <div class="notification-dropdown">
                    <!-- Pending users populated by JS -->
                </div>
            </div>
            <div class="user-profile">
                <i class='bx bxs-user-circle'></i>
                <div class="profile-dropdown">
                    <div class="profile-dropdown-header">
                        <img id="profile-avatar-img" src="https://i.pravatar.cc/40" alt="Avatar" class="profile-avatar">
                        <div>
                            <span id="profile-username-display" style="font-weight: bold;">User</span>
                        </div>
                    </div>
                    <div class="profile-dropdown-links">
                        <a href="profile.html">Edit Profile</a>
                        <button onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <main>
        <!-- KPI CARDS -->
        <div class="grid-container" style="margin-bottom: 20px;">
            <div class="kpi-card" onclick="window.location.href='devices.html?filter=recent'">
                <div class="title">Todays Tests</div>
                <div class="value" id="tests-today-value">...</div>
            </div>
            <div class="kpi-card" onclick="window.location.href='devices.html?filter=pass'">
                <div class="title">Passed Devices</div>
                <div class="value success" id="passed-devices-value">...</div>
            </div>
            <div class="kpi-card" onclick="window.location.href='devices.html?filter=failed'">
                <div class="title">Failed Devices</div>
                <div class="value critical" id="critical-alerts-value">...</div>
            </div>
            <div class="kpi-card" onclick="window.location.href='devices.html?filter=all'">
                <div class="title">Total Devices</div>
                <div class="value" id="total-devices-value">...</div>
            </div>
        </div>

        <div class="grid-container">
            <!-- Test Overview -->
            <div class="card" style="grid-column: span 2;">
                <div class="card-title-container">
                    <div class="card-title" id="overview-title">Monthly Test Overview</div>
                    <div class="chart-filter">
                        <select id="year-filter" onchange="renderDashboard()"></select>
                    </div>
                </div>
                <div id="overview-container" style="height: 300px;">
                    <canvas id="monthly-tests-chart"></canvas>
                </div>
            </div>

            <!-- Result Distribution -->
            <div class="card">
                <div class="card-title">Result Distribution</div>
                <div class="pie-chart-container">
                    <svg class="pie-chart-svg" viewBox="0 0 100 100"></svg>
                    <div class="chart-tooltip"></div>
                    <div class="pie-chart-legend" id="pie-chart-legend"></div>
                </div>
            </div>

            <!-- Device & Test Activity Feed -->
            <div class="card">
                <div class="card-title">Device & Test Activity</div>
                <ul class="activity-feed" id="activity-feed"></ul>
            </div>

        </div>
    </main>
</div>

<script>
    const userStr = sessionStorage.getItem('user');
    let user;
    let globalDiagnostics = [];
    let globalTerminals = [];
    let globalUsers = [];
    let monthlyChart = null; // Chart.js instance
    const API_KEY = "supersecret123";

    if (!userStr) {
        window.location.href = '/login.html';
    } else {
        user = JSON.parse(userStr);
        document.getElementById('welcomeMessage').innerText = `Welcome, ${user.username}`;
        document.getElementById('profile-username-display').innerText = user.username;
        const savedAvatar = localStorage.getItem(`avatar_${user.username}`);
        if(savedAvatar) {
            document.getElementById('profile-avatar-img').src = savedAvatar;
        }

        if (user.role !== 'admin') {
            const adminSection = document.getElementById('admin-section');
            if (adminSection) adminSection.style.display = 'none';
            const adminUsersLink = document.getElementById('adminUsersLink');
            if (adminUsersLink) adminUsersLink.style.display = 'none';
            const adminSettingsLink = document.getElementById('adminSettingsLink');
            if (adminSettingsLink) adminSettingsLink.style.display = 'none';
        }
    }

    function logout() {
        sessionStorage.clear();
        window.location.href = '/login.html';
    }

    function toggleSidebar() {
        const sidebar = document.querySelector(".sidebar");
        const mainContent = document.querySelector(".main-content");
        sidebar.classList.toggle("collapsed");
        mainContent.classList.toggle("collapsed");
        localStorage.setItem('sidebar-collapsed', sidebar.classList.contains('collapsed'));
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (localStorage.getItem('sidebar-collapsed') === 'true') {
            document.querySelector('.sidebar').classList.add('collapsed');
            document.querySelector('.main-content').classList.add('collapsed');
        }
        fetchDataAndRender();
        setInterval(fetchDataAndRender, 5000);

        // Dropdown Toggle Logic
        document.querySelectorAll('.user-profile, .notification-container').forEach(container => {
            const i = container.querySelector('i');
            const dropdown = container.querySelector('.profile-dropdown, .notification-dropdown');
            i.addEventListener('click', (event) => {
                if(dropdown) dropdown.classList.toggle('show');
                event.stopPropagation();
            });
        });

        window.addEventListener('click', () => {
            document.querySelectorAll('.profile-dropdown, .notification-dropdown').forEach(dropdown => {
                if (dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                }
            });
        });
    });

    async function fetchDataAndRender() {
        const promises = [
            fetch(`/diagnostics?api_key=${API_KEY}`),
            fetch(`/terminals?api_key=${API_KEY}`)
        ];
        if (user.role === 'admin') {
            promises.push(fetch(`/auth/users`));
        }

        const results = await Promise.allSettled(promises);

        globalDiagnostics = (results[0].status === 'fulfilled' && results[0].value.ok) ? await results[0].value.json() : [];
        globalTerminals = (results[1].status === 'fulfilled' && results[1].value.ok) ? await results[1].value.json() : [];
        
        if (user.role === 'admin' && results.length > 2 && results[2].status === 'fulfilled' && results[2].value.ok) {
            globalUsers = await results[2].value.json();
        }

        renderDashboard();
    }
    
    function renderDashboard() {
        populateYearFilter(globalDiagnostics);
        updateKpis(globalDiagnostics, globalTerminals);
        updateActivityFeed(globalDiagnostics);
        updateResultDistribution(globalTerminals);
        updateTestOverview(globalDiagnostics);
        if (user.role === 'admin') {
            updateNotifications(globalUsers);
        }
    }

    function populateYearFilter(diagnostics) {
        const yearFilter = document.getElementById('year-filter');
        if (!yearFilter) return;
        const currentSelectedValue = yearFilter.value || new Date().getFullYear();
        const years = [...new Set(diagnostics.map(d => new Date(d.receivedAt).getFullYear()))];
        years.push(new Date().getFullYear());
        const sortedYears = [...new Set(years)].sort((a, b) => b - a);
        
        if (yearFilter.options.length !== sortedYears.length) {
             yearFilter.innerHTML = '';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.text = year;
                yearFilter.appendChild(option);
            });
        }
        yearFilter.value = currentSelectedValue;
    }

    function updateKpis(diagnostics, terminals) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const testsToday = diagnostics.filter(d => new Date(d.receivedAt) >= today);
        const criticalAlerts = terminals.filter(t => t.last_status === 'fail');
        const passedDevices = terminals.filter(t => t.last_status === 'pass');
        document.getElementById('tests-today-value').innerText = testsToday.length;
        document.getElementById('critical-alerts-value').innerText = criticalAlerts.length;
        document.getElementById('passed-devices-value').innerText = passedDevices.length;
        document.getElementById('total-devices-value').innerText = terminals.length;
    }

    function updateActivityFeed(diagnostics) {
        const feed = document.getElementById('activity-feed');
        if(!feed) return;
        feed.innerHTML = '';
        const recent = diagnostics.sort((a, b) => new Date(b.receivedAt) - new Date(a.receivedAt)).slice(0, 5);
        recent.forEach(d => {
            const item = document.createElement('li');
            const statusClass = d.summaryStatus === 'fail' ? 'highlight' : '';
            item.innerHTML = `New test on ${d.payload.terminal_id} finished with status <span class="${statusClass}">${d.summaryStatus}</span> <span class="time">${new Date(d.receivedAt).toLocaleTimeString()}</span>`;
            feed.appendChild(item);
        });
    }

    function updateResultDistribution(terminals) {
        const pieSvg = document.querySelector('.pie-chart-svg');
        if(!pieSvg) return;
        const tooltip = document.querySelector('.chart-tooltip');
        const legendContainer = document.getElementById('pie-chart-legend');
        pieSvg.innerHTML = '';
        legendContainer.innerHTML = '';

        if (!terminals || terminals.length === 0) {
            pieSvg.innerHTML = '<text x="50" y="50" text-anchor="middle" fill="#7f8c8d">No data</text>';
            return;
        }

        const passCount = terminals.filter(t => t.last_status === 'pass').length;
        const failCount = terminals.filter(t => t.last_status === 'fail').length;
        const notTestedCount = terminals.length - passCount - failCount;
        const total = terminals.length;

        const data = [
            { label: 'Pass', count: passCount, color: 'var(--success)' },
            { label: 'Fail', count: failCount, color: 'var(--danger)' },
            { label: 'Not Tested', count: notTestedCount, color: 'var(--text-muted)' }
        ];

        let cumulativePercent = 0;

        const getSlicePath = (startAngle, endAngle, radius) => {
            const x1 = 50 + radius * Math.cos(Math.PI * startAngle / 180);
            const y1 = 50 + radius * Math.sin(Math.PI * startAngle / 180);
            const x2 = 50 + radius * Math.cos(Math.PI * endAngle / 180);
            const y2 = 50 + radius * Math.sin(Math.PI * endAngle / 180);
            const largeArcFlag = (endAngle - startAngle) > 180 ? 1 : 0;
            return `M 50,50 L ${x1},${y1} A ${radius},${radius} 0 ${largeArcFlag} 1 ${x2},${y2} Z`;
        };

        data.forEach(item => {
            const percent = (total > 0) ? (item.count / total) * 100 : 0;
            if (percent > 0) {
                const startAngle = (cumulativePercent / 100) * 360;
                const endAngle = ((cumulativePercent + percent) / 100) * 360;

                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("class", "pie-slice");
                path.setAttribute("d", getSlicePath(startAngle, endAngle, 50));
                path.setAttribute("fill", item.color);
                
                path.addEventListener('mousemove', (e) => {
                    const chartRect = pieSvg.getBoundingClientRect();
                    tooltip.style.opacity = 1;
                    tooltip.style.left = `${e.clientX - chartRect.left}px`;
                    tooltip.style.top = `${e.clientY - chartRect.top}px`;
                    tooltip.innerText = `${item.label}: ${item.count}`;
                });
                path.addEventListener('mouseout', () => {
                    tooltip.style.opacity = 0;
                });

                pieSvg.appendChild(path);
                cumulativePercent += percent;
            }
        });

        data.forEach(item => {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            legendItem.innerHTML = `<span class="legend-color" style="background-color: ${item.color};"></span>${item.label}`;
            legendContainer.appendChild(legendItem);
        });
    }

    function updateTestOverview(diagnostics) {
        const ctx = document.getElementById('monthly-tests-chart')?.getContext('2d');
        if(!ctx) return;
        const yearFilter = document.getElementById('year-filter');
        const selectedYear = parseInt(yearFilter.value) || new Date().getFullYear();

        document.getElementById('overview-title').innerText = `Monthly Test Overview for ${selectedYear}`;
        
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthlyCounts = Array(12).fill(0);

        diagnostics
            .filter(d => new Date(d.receivedAt).getFullYear() === selectedYear)
            .forEach(d => {
                const month = new Date(d.receivedAt).getMonth();
                monthlyCounts[month]++;
            });

        if (monthlyChart) {
            monthlyChart.destroy();
        }

        monthlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: monthNames,
                datasets: [{
                    label: `Tests in ${selectedYear}`,
                    data: monthlyCounts,
                    backgroundColor: 'rgba(30, 136, 229, 0.7)',
                    borderColor: 'rgba(30, 136, 229, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: {
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Number of Tests' }
                    }
                },
                 onClick: (e) => {
                    const activePoints = monthlyChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                    if (activePoints.length) {
                        const firstPoint = activePoints[0];
                        const monthIndex = firstPoint.index;
                        window.location.href = `daily_report.html?year=${selectedYear}&month=${monthIndex + 1}`;
                    }
                }
            }
        });
    }

    function updateNotifications(users) {
        const notificationBell = document.getElementById('notification-bell');
        if (!notificationBell) return;
        const countElement = notificationBell.querySelector('.notification-count');
        const dropdown = notificationBell.querySelector('.notification-dropdown');
        
        if (!users || user.role !== 'admin') {
            notificationBell.style.display = 'none';
            return;
        }

        notificationBell.style.display = 'block';
        const pendingUsers = users.filter(u => u.status === 'pending');
        dropdown.innerHTML = '';

        if (pendingUsers.length > 0) {
            countElement.innerText = pendingUsers.length;
            countElement.style.display = 'block';
            pendingUsers.forEach(user => {
                const link = document.createElement('a');
                link.href = '/users.html';
                link.innerText = `New signup: ${user.username}`;
                dropdown.appendChild(link);
            });
        } else {
            countElement.style.display = 'none';
            dropdown.innerHTML = '<div class="no-notifications">No new notifications</div>';
        }
    }
</script>

</body>
</html>
